<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Las Luchas de las Tribus - Tablero</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #654321;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            position: relative;
            margin: 0;
            padding: 0;
        }

        .turn-timer-display {
            font-size: 2em;
            font-weight: bold;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.7);
            border: 3px solid #666;
            border-radius: 10px;
            min-width: 80px;
            text-align: center;
        }

        .turn-timer-display.warning {
            color: #ff0000;
            border-color: #ff0000;
            animation: blink 0.5s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .ready-button {
            padding: 10px 25px;
            font-size: 1.3em;
            background: #4CAF50;
            color: white;
            border: 3px solid #333;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .ready-button:hover {
            background: #45a049;
            transform: scale(1.05);
        }

        .ready-button:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .game-container {
            width: 95%;
            height: 95vh;
            background: rgba(0, 0, 0, 0.3);
            border: 4px solid #333;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 5px;
            position: relative;
            z-index: 1;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .player-info {
            font-size: 1.2em;
        }

        .combat-zone {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 40px;
            padding: 20px 0;
        }

        .battle-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 10px;
        }

        .opponent-row {
            border-bottom: 2px dashed rgba(255, 255, 255, 0.3);
        }

        .combat-slot {
            width: 140px;
            height: 200px;
            border: 3px dashed rgba(255, 255, 255, 0.4);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .combat-slot.occupied {
            border-style: solid;
            border-color: #ffcc00;
        }

        .combat-slot.healable {
            border-color: #00ff00;
            box-shadow: 0 0 15px #00ff00;
            cursor: pointer;
        }

        .card {
            width: 130px;
            height: 190px;
            background: linear-gradient(135deg, #5d0f19 0%, #3a0a10 100%);
            border: 3px solid #f5e6b9;
            border-radius: 8px;
            padding: 8px;
            cursor: grab;
            transition: transform 0.2s;
            position: relative;
        }

        .card:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px #ffcc00;
        }

        .card-header {
            font-size: 0.9em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 5px;
            color: #ffcc00;
        }

        .card-image {
            width: 100%;
            height: 80px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            font-size: 0.7em;
        }

        .card-stats {
            display: flex;
            justify-content: space-around;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .stat {
            background: rgba(0, 0, 0, 0.5);
            padding: 3px 6px;
            border-radius: 3px;
        }

        .stat-atk { color: #ff4444; }
        .stat-vida { color: #44ff44; }
        .stat-vel { color: #4444ff; }
        .stat-cur { color: #ffaa00; }

        .hand-zone {
            height: 220px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            padding: 10px;
            border: 2px solid #ffcc00;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
            align-items: center;
        }

        button {
            padding: 12px 25px;
            font-size: 1.1em;
            background: #e6675e;
            color: white;
            border: 3px solid #ffcc00;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        button:hover {
            background: #c44f45;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .card.healing-selected {
            border-color: #00ff00;
            box-shadow: 0 0 20px #00ff00;
        }

        .card.bot-card {
            width: 100px;
            height: 140px;
            font-size: 0.75em;
            background: linear-gradient(135deg, #1a0a0a 0%, #0a0505 100%);
            border-color: #ff0000;
        }

        .card.bot-card .card-header {
            font-size: 0.75em;
        }

        .card.bot-card .card-stats {
            font-size: 0.7em;
        }

        .game-log {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 300px;
            max-height: 400px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ffcc00;
            border-radius: 5px;
            padding: 10px;
            overflow-y: auto;
            font-size: 0.85em;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 3px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <div class="player-info">
                <strong>Tribu Nora (Rival)</strong>
            </div>
            <div class="player-info" style="text-align: center;">
                <div style="font-size: 1.5em; color: #ffcc00;" id="timer">2:00</div>
                <div style="font-size: 1.8em; color: #ff4444; font-weight: bold;" id="turn-timer">15</div>
                <div id="turn-indicator" style="font-size: 1em; color: #44ff44;">Tu Turno</div>
                <div id="night-mode-indicator" style="display: none; color: #4444ff;">üåô MODO NOCHE üåô</div>
            </div>
            <div class="player-info">
                <strong>Tribu Orah (T√∫)</strong>
            </div>
        </div>

        <div class="hand-zone" id="bot-hand" style="height: 120px; gap: 10px; margin-top: 10px; margin-bottom: 10px; opacity: 0.8;">
        </div>

        <div class="combat-zone">
            <div class="battle-row opponent-row" id="opponent-field">
                <div class="combat-slot" data-slot="0"></div>
            </div>

            <div class="battle-row player-row" id="player-field">
                <div class="combat-slot" data-slot="0"></div>
            </div>
        </div>

        <div class="hand-zone" id="player-hand">
        </div>

        <div class="controls">
            <button onclick="window.location.href='index.html'">Volver al Men√∫</button>
            <div class="turn-timer-display" id="turn-timer-display">15</div>
            <button class="ready-button" id="ready-btn" onclick="passTurnManually()" disabled>LISTO ‚úì</button>
        </div>
    </div>

    <div class="game-log" id="game-log">
        <strong>--- Log de Juego ---</strong>
    </div>

    <script>
        let deck = [];
        let playerHand = [];
        let playerField = [null];
        let opponentField = [null];
        let currentTurn = 1;
        let gameActive = true;
        
        let timeRemaining = 120;
        let timerInterval = null;
        let nightModeActive = false;
        
        let turnTimeRemaining = 15;
        let turnTimerInterval = null;
        let isPlayerTurnActive = false;
        let cardPlayedThisTurn = false;
        
        let botDeck = [];
        let botHand = [];
        let botDifficulty = 'medium';
        
        let selectedHealingCard = null;

        function addLog(message) {
            const logDiv = document.getElementById('game-log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `[Turno ${currentTurn}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                if (!gameActive) {
                    clearInterval(timerInterval);
                    return;
                }
                
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining === 60 && !nightModeActive) {
                    activateNightMode();
                }
                
                if (timeRemaining <= 0) {
                    endGame('tiempo');
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const timerDisplay = document.getElementById('timer');
            timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeRemaining <= 30) {
                timerDisplay.style.color = '#ff4444';
            } else if (timeRemaining <= 60) {
                timerDisplay.style.color = '#ffaa00';
            }
        }

        function startTurnTimer() {
            turnTimeRemaining = 15;
            cardPlayedThisTurn = false;
            document.getElementById('ready-btn').disabled = true;
            updateTurnTimerDisplay();
            
            if (turnTimerInterval) {
                clearInterval(turnTimerInterval);
            }
            
            turnTimerInterval = setInterval(() => {
                if (!gameActive) {
                    clearInterval(turnTimerInterval);
                    return;
                }
                
                turnTimeRemaining--;
                updateTurnTimerDisplay();
                
                if (turnTimeRemaining <= 0) {
                    clearInterval(turnTimerInterval);
                    
                    if (isPlayerTurnActive && !cardPlayedThisTurn) {
                        autoPlayCard();
                    }
                    
                    endPlayerTurn();
                }
            }, 1000);
        }

        function updateTurnTimerDisplay() {
            const timerDisplay = document.getElementById('turn-timer-display');
            const turnTimer = document.getElementById('turn-timer');
            
            if (timerDisplay) {
                timerDisplay.textContent = turnTimeRemaining;
                
                if (turnTimeRemaining <= 5) {
                    timerDisplay.style.color = '#ff0000';
                    timerDisplay.classList.add('warning');
                } else if (turnTimeRemaining <= 10) {
                    timerDisplay.style.color = '#ff8800';
                    timerDisplay.classList.remove('warning');
                } else {
                    timerDisplay.style.color = '#44ff44';
                    timerDisplay.classList.remove('warning');
                }
            }
            
            if (turnTimer) turnTimer.textContent = turnTimeRemaining;
        }

        function autoPlayCard() {
            const availableCards = playerHand.filter(c => c.tipo === 'Luchador');
            const emptySlot = playerField.findIndex(slot => slot === null);
            
            if (availableCards.length > 0 && emptySlot !== -1) {
                const randomCard = availableCards[Math.floor(Math.random() * availableCards.length)];
                playerField[emptySlot] = randomCard;
                
                const cardIndex = playerHand.findIndex(c => c.id === randomCard.id);
                playerHand.splice(cardIndex, 1);
                
                addLog(`‚è∞ Tiempo agotado - Sistema jug√≥: ${randomCard.nombre}`);
                renderHand();
                renderField();
            } else {
                addLog('‚è∞ Tiempo agotado - Sin cartas para jugar');
            }
        }

        function updateTurnIndicator() {
            const indicator = document.getElementById('turn-indicator');
            if (isPlayerTurnActive) {
                indicator.textContent = '‚ñº Tu Turno';
                indicator.style.color = '#44ff44';
            } else {
                indicator.textContent = '‚ñ≤ Turno del Rival';
                indicator.style.color = '#ff4444';
            }
        }

        function endPlayerTurn() {
            processCombat();
            checkVictoryConditions();
            switchTurn();
        }

        function switchTurn() {
            isPlayerTurnActive = !isPlayerTurnActive;
            updateTurnIndicator();
            
            if (isPlayerTurnActive) {
                addLog('‚ïê‚ïê‚ïê Tu turno - 15 segundos ‚ïê‚ïê‚ïê');
                startTurnTimer();
            } else {
                addLog('‚ïê‚ïê‚ïê Turno del rival ‚ïê‚ïê‚ïê');
                
                setTimeout(() => {
                    if (!isPlayerTurnActive && gameActive) {
                        opponentTurn();
                        
                        setTimeout(() => {
                            processCombat();
                            checkVictoryConditions();
                            switchTurn();
                        }, 1000);
                    }
                }, 500);
            }
        }

        function activateNightMode() {
            nightModeActive = true;
            addLog('üåô ¬°MODO NOCHE ACTIVADO! Todos los luchadores pierden 1 de vida');
            
            document.getElementById('night-mode-indicator').style.display = 'block';
            document.body.style.background = 'linear-gradient(to bottom, #1a0f2e 0%, #0a0514 100%)';
            
            applyNightModeDamage();
        }

        function applyNightModeDamage() {
            addLog('üåô === EFECTO DEL MODO NOCHE ===');
            
            playerField.forEach((card, index) => {
                if (card && card.tipo === 'Luchador') {
                    card.vida -= 1;
                    addLog(`${card.nombre}: -1 Vida (Ahora: ${card.vida})`);
                    
                    if (card.vida <= 0) {
                        addLog(`üíÄ ${card.nombre} ha muerto por la noche`);
                        playerField[index] = null;
                    }
                }
            });
            
            opponentField.forEach((card, index) => {
                if (card && card.tipo === 'Luchador') {
                    card.vida -= 1;
                    addLog(`${card.nombre} (rival): -1 Vida (Ahora: ${card.vida})`);
                    
                    if (card.vida <= 0) {
                        addLog(`üíÄ ${card.nombre} (rival) ha muerto por la noche`);
                        opponentField[index] = null;
                    }
                }
            });
            
            addLog('Las curaciones ahora curan 50% menos');
            renderField();
        }

        async function loadCards() {
            try {
                botDifficulty = 'medium';
                
                const mockCards = [
                    {id: 1, nombre: "Guerrero", tipo: "Luchador", ataque: 5, vida: 8, velocidad: 3, descripcion: "Guerrero b√°sico"},
                    {id: 2, nombre: "Arquero", tipo: "Luchador", ataque: 4, vida: 6, velocidad: 5, descripcion: "R√°pido y letal"},
                    {id: 3, nombre: "Tanque", tipo: "Luchador", ataque: 3, vida: 10, velocidad: 2, descripcion: "Resistente"},
                    {id: 4, nombre: "Curaci√≥n Menor", tipo: "Curaci√≥n", curacion: 3, descripcion: "Restaura vida"},
                    {id: 5, nombre: "Curaci√≥n Mayor", tipo: "Curaci√≥n", curacion: 5, descripcion: "Gran curaci√≥n"}
                ];
                
                deck = [...mockCards];
                addLog('Cartas cargadas');
                
                await loadBotDeck();
                
                drawInitialHand();
            } catch (error) {
                addLog('ERROR: No se pudo cargar cartas');
                console.error(error);
            }
        }

        async function loadBotDeck() {
            const mockBotCards = [
                {id: 'b1', nombre: "Soldado Oscuro", tipo: "Luchador", ataque: 5, vida: 7, velocidad: 4, descripcion: "Guerrero enemigo"},
                {id: 'b2', nombre: "Asesino", tipo: "Luchador", ataque: 6, vida: 5, velocidad: 6, descripcion: "Ataque r√°pido"},
                {id: 'b3', nombre: "Guardi√°n", tipo: "Luchador", ataque: 4, vida: 9, velocidad: 2, descripcion: "Defensor"},
                {id: 'b4', nombre: "Sanaci√≥n", tipo: "Curaci√≥n", curacion: 3, descripcion: "Cura aliados"},
                {id: 'b5', nombre: "Sanaci√≥n +", tipo: "Curaci√≥n", curacion: 5, descripcion: "Gran sanaci√≥n"}
            ];
            
            botDeck = [...mockBotCards];
            botHand = [...botDeck];
            
            addLog(`Bot cargado: 3 luchadores + 2 curaciones`);
            renderBotHand();
        }

        function renderBotHand() {
            const botHandDiv = document.getElementById('bot-hand');
            botHandDiv.innerHTML = '';
            
            botHand.forEach((card) => {
                const cardElement = createBotCardElement(card);
                botHandDiv.appendChild(cardElement);
            });
        }

        function createBotCardElement(card) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'card bot-card';
            
            let statsHTML = '';
            if (card.tipo === 'Luchador') {
                statsHTML = `
                    <div class="card-stats">
                        <span class="stat stat-atk">‚öî${card.ataque}</span>
                        <span class="stat stat-vida">‚ù§${card.vida}</span>
                        <span class="stat stat-vel">‚ö°${card.velocidad}</span>
                    </div>
                `;
            } else {
                statsHTML = `
                    <div class="card-stats">
                        <span class="stat stat-cur">‚úö${card.curacion}</span>
                    </div>
                `;
            }
            
            cardDiv.innerHTML = `
                <div class="card-header">${card.nombre}</div>
                <div class="card-image" style="height: 50px; font-size: 0.65em;">${card.tipo}</div>
                ${statsHTML}
            `;
            
            return cardDiv;
        }

        function drawInitialHand() {
            deck.forEach(card => {
                playerHand.push(card);
            });
            
            renderHand();
        }

        function renderHand() {
            const handDiv = document.getElementById('player-hand');
            
            if (!handDiv) {
                console.error('No se encontr√≥ el elemento player-hand');
                return;
            }
            
            handDiv.innerHTML = '';
            
            if (playerHand.length === 0) {
                handDiv.innerHTML = '<div style="color: white;">Sin cartas en la mano</div>';
                return;
            }
            
            playerHand.forEach((card, index) => {
                const cardElement = createCardElement(card, index);
                
                if (card.tipo === 'Curaci√≥n') {
                    cardElement.onclick = () => selectHealingCard(card, index);
                    cardElement.style.cursor = 'pointer';
                }
                
                handDiv.appendChild(cardElement);
            });
        }

        function selectHealingCard(card, handIndex) {
            if (selectedHealingCard === handIndex) {
                selectedHealingCard = null;
                renderHand();
                clearHealableSlots();
                addLog('Curaci√≥n cancelada');
            } else {
                selectedHealingCard = handIndex;
                renderHand();
                highlightHealableSlots();
                addLog(`Seleccionaste: ${card.nombre} - Clic en un luchador para curarlo`);
            }
        }

        function highlightHealableSlots() {
            const playerSlots = document.querySelectorAll('#player-field .combat-slot');
            playerSlots.forEach((slot, index) => {
                if (playerField[index] && playerField[index].tipo === 'Luchador') {
                    slot.classList.add('healable');
                    slot.onclick = () => applyHealing(index);
                }
            });
        }

        function clearHealableSlots() {
            const playerSlots = document.querySelectorAll('#player-field .combat-slot');
            playerSlots.forEach(slot => {
                slot.classList.remove('healable');
                slot.onclick = null;
            });
        }

        function applyHealing(slotIndex) {
            if (!isPlayerTurnActive) {
                addLog('‚ö†Ô∏è No es tu turno');
                return;
            }
            
            if (cardPlayedThisTurn) {
                addLog('‚ö†Ô∏è Solo puedes jugar 1 carta por turno');
                return;
            }
            
            if (selectedHealingCard === null) return;
            
            const healCard = playerHand[selectedHealingCard];
            const targetCard = playerField[slotIndex];
            
            if (!targetCard) return;
            
            const healAmount = nightModeActive ? Math.floor(healCard.curacion / 2) : healCard.curacion;
            targetCard.vida += healAmount;
            
            addLog(`‚úì ${targetCard.nombre} curado +${healAmount} vida (Total: ${targetCard.vida})`);
            
            playerHand.splice(selectedHealingCard, 1);
            selectedHealingCard = null;
            
            renderHand();
            renderField();
            clearHealableSlots();
            
            cardPlayedThisTurn = true;
            
            document.getElementById('ready-btn').disabled = false;
            addLog('Presiona LISTO para pasar turno o espera 15 seg');
        }

        function createCardElement(card, handIndex = -1) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'card';
            
            if (handIndex === selectedHealingCard) {
                cardDiv.classList.add('healing-selected');
            }
            
            cardDiv.draggable = true;
            
            if (handIndex >= 0) {
                cardDiv.dataset.handIndex = handIndex;
                cardDiv.ondragstart = dragStart;
            }
            
            let statsHTML = '';
            if (card.tipo === 'Luchador') {
                statsHTML = `
                    <div class="card-stats">
                        <span class="stat stat-atk">‚öî ${card.ataque}</span>
                        <span class="stat stat-vida">‚ù§ ${card.vida}</span>
                        <span class="stat stat-vel">‚ö° ${card.velocidad}</span>
                    </div>
                `;
            } else {
                statsHTML = `
                    <div class="card-stats">
                        <span class="stat stat-cur">‚úö ${card.curacion}</span>
                    </div>
                `;
            }
            
            cardDiv.innerHTML = `
                <div class="card-header">${card.nombre}</div>
                <div class="card-image">${card.tipo}</div>
                <div style="font-size: 0.75em; text-align: center; margin: 5px 0;">
                    ${card.descripcion.substring(0, 50)}...
                </div>
                ${statsHTML}
            `;
            
            return cardDiv;
        }

        let draggedCardIndex = null;

        function dragStart(e) {
            draggedCardIndex = parseInt(e.target.dataset.handIndex);
            e.dataTransfer.effectAllowed = 'move';
        }

        document.addEventListener('DOMContentLoaded', () => {
            const playerSlots = document.querySelectorAll('#player-field .combat-slot');
            playerSlots.forEach(slot => {
                slot.ondragover = dragOver;
                slot.ondrop = drop;
            });
        });

        function dragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function drop(e) {
            e.preventDefault();
            
            if (!isPlayerTurnActive) {
                addLog('‚ö†Ô∏è No es tu turno');
                return;
            }
            
            if (cardPlayedThisTurn) {
                addLog('‚ö†Ô∏è Solo puedes jugar 1 carta por turno');
                return;
            }
            
            if (draggedCardIndex === null) return;
            
            const slotIndex = parseInt(e.currentTarget.dataset.slot);
            const card = playerHand[draggedCardIndex];
            
            if (playerField[slotIndex] !== null) {
                addLog('Ese slot ya est√° ocupado');
                return;
            }
            
            if (card.tipo === 'Luchador') {
                playerField[slotIndex] = card;
                playerHand.splice(draggedCardIndex, 1);
                
                addLog(`‚úì Jugaste: ${card.nombre}`);
                renderHand();
                renderField();
                
                cardPlayedThisTurn = true;
                
                document.getElementById('ready-btn').disabled = false;
                addLog('Presiona LISTO para pasar turno o espera 15 seg');
            } else {
                addLog('Las curaciones no se juegan en el campo');
            }
            
            draggedCardIndex = null;
        }

        function passTurnManually() {
            if (!cardPlayedThisTurn) return;
            
            addLog('‚úì Pasaste turno manualmente');
            document.getElementById('ready-btn').disabled = true;
            clearInterval(turnTimerInterval);
            
            setTimeout(() => {
                endPlayerTurn();
            }, 500);
        }

        function renderField() {
            const playerSlots = document.querySelectorAll('#player-field .combat-slot');
            playerSlots.forEach((slot, index) => {
                slot.innerHTML = '';
                if (playerField[index]) {
                    const card = createCardElement(playerField[index]);
                    card.draggable = false;
                    slot.appendChild(card);
                    slot.classList.add('occupied');
                } else {
                    slot.classList.remove('occupied');
                }
            });
            
            const opponentSlots = document.querySelectorAll('#opponent-field .combat-slot');
            opponentSlots.forEach((slot, index) => {
                slot.innerHTML = '';
                if (opponentField[index]) {
                    const card = createCardElement(opponentField[index]);
                    card.classList.add('opponent');
                    card.draggable = false;
                    slot.appendChild(card);
                    slot.classList.add('occupied');
                } else {
                    slot.classList.remove('occupied');
                }
            });
        }

        function endGame(reason) {
            gameActive = false;
            clearInterval(timerInterval);
            clearInterval(turnTimerInterval);
            
            let message = '';
            if (reason === 'tiempo') {
                const playerAlive = playerField.filter(c => c !== null).length;
                const